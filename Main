#NoEnv  ; Recommended for performance and compatibility with future AutoHotkey releases.
; #Warn  ; Enable warnings to assist with detecting common errors.
SendMode Input  ; Recommended for new scripts due to its superior speed and reliability.
SetWorkingDir %A_ScriptDir%  ; Ensures a consistent starting directory.
StringCaseSense, Locale
#Include <JSON> ; AHK-JSON lib ; https://github.com/cocobelgica/AutoHotkey-JSON

{ ; СТАРТ

Script_Version := 3.9

global Center_X := A_ScreenWidth/2
global Center_Y := A_ScreenHeight/2



Updated_Text := URLDownloadToVar("https://raw.githubusercontent.com/Oakenlix/IRevive_Framework/main/Main")
RegexMatch(Updated_Text, "Script_Version := (\d.\d)", Updated_Version)
If Updated_Version1
and (Updated_Version1 != Script_Version)
{
	FileCreateDir, %A_ScriptDir%\Backups
	FileMove, %A_ScriptName%, %A_ScriptDir%\Backups\%A_Hour%%A_Min%-%A_DD%%A_MM%.ahk
	FileAppend, %Updated_Text%, %A_ScriptName%
	sleep 100
	Run, %A_ScriptName%
	ExitApp
}
Updated_Text :=
	
URLDownloadToVar(url) 
{
	try  ; Attempts to execute code.
	{
		WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
		WebRequest.Open("GET", url)
		WebRequest.Send()
		Return, WebRequest.ResponseText
	}
	catch  ; Handles the first error/exception raised by the block above.
	{
		MsgBox, 262144, Ошибка, Нет подключения к интернету. Некоторые функции не будут работать.
	}
}

; ####################################### Загрузка настроек

If !FileExist("Settings.ini")
{
	IniWrite, 0, Settings.ini, window position, RemoveWindow
	IniWrite, 1, Settings.ini, EzCad, CadDelay1
	IniWrite, 0 0, Settings.ini, EzCad, Cadclick1
	IniWrite, 0 0, Settings.ini, EzCad, Cadclick2
	IniWrite, 0 0, Settings.ini, EzCad, Cadclick3
	IniWrite, 0 0, Settings.ini, EzCad, Cadclick4
	IniWrite, 0 0, Settings.ini, EzCad, Cadclick5
}

IniRead()
IniRead, username, Settings.ini, user, name, Имя
IniRead, department, Settings.ini, user, department
If (DEPARTMENT == "Сувенирка") or (DEPARTMENT == "УФ печать")
{
	IniWrite, 0, Settings.ini, user, EnableFilter
}
IniRead, EnableFilter, Settings.ini, user, EnableFilter
IniRead, SetOnTop, Settings.ini, user, SetOnTop
IniRead, LaunchMinimized, Settings.ini, user, LaunchMinimized
IniRead, RemoveWindow, Settings.ini, window position, RemoveWindow, 0
IniRead, gui_position, Settings.ini, window position, gui_position, w500 h300

IniRead, OZONcol1, Settings.ini, window position, OZONcol1, 100
IniRead, OZONcol2, Settings.ini, window position, OZONcol2, 100
IniRead, OZONcol3, Settings.ini, window position, OZONcol3, 100
IniRead, OZONcol4, Settings.ini, window position, OZONcol4, 100

IniRead, YANDEXcol1, Settings.ini, window position, YANDEXcol1, 100
IniRead, YANDEXcol2, Settings.ini, window position, YANDEXcol2, 100
IniRead, YANDEXcol3, Settings.ini, window position, YANDEXcol3, 100
IniRead, YANDEXcol4, Settings.ini, window position, YANDEXcol4, 100

IniRead, WBcol1, Settings.ini, window position, WBcol1, 100
IniRead, WBcol2, Settings.ini, window position, WBcol2, 100
IniRead, WBcol3, Settings.ini, window position, WBcol3, 100
IniRead, WBcol4, Settings.ini, window position, WBcol4, 100

IniRead, Y_Poisk, Settings.ini, Yandex, Y_Poisk
IniRead, Y_Zakaz, Settings.ini, Yandex, Y_Zakaz
IniRead, Y_Kartinka, Settings.ini, Yandex, Y_Kartinka
IniRead, Y_Etiketka, Settings.ini, Yandex, Y_Etiketka

IniRead, CadDelay1, Settings.ini, EzCad, CadDelay1, 1
global Cadclick1
IniRead, Cadclick1, Settings.ini, EzCad, Cadclick1
IniRead, Cadclick2, Settings.ini, EzCad, Cadclick2
IniRead, Cadclick3, Settings.ini, EzCad, Cadclick3
IniRead, Cadclick4, Settings.ini, EzCad, Cadclick4
IniRead, Cadclick5, Settings.ini, EzCad, Cadclick5

IniRead, UVclick1, Settings.ini, UV, UVclick1
IniRead, UVclick2, Settings.ini, UV, UVclick2
IniRead, UVclick3, Settings.ini, UV, UVclick3
IniRead, UVclick4, Settings.ini, UV, UVclick4
IniRead, UVclick5, Settings.ini, UV, UVclick5

LoadMainGUI()
If LaunchMinimized and (LaunchMinimized != "Error") ; Сразу свернуть, если выбрана эта опция
		WinMinimize, %A_ScriptName%
return

LoadMainGUI()
{
	global
	Gui, Add, Button,, Помощь
	Gui, Add, Text, xs y+15, Настройки
	Gui, Add, Text, xs, Имя:
	Gui, Add, Edit, w100 x+3 gGUI_updatesettings vUSERNAME, % username
	Gui, Add, Text, x+3, Отдел:
	Gui, Add, DropDownList, w130 x+3 gGUI_updatesettings vDEPARTMENT, Аксы/Пленка|Сувенирка|УФ печать|УФ Nocai
	GuiControl, ChooseString, DEPARTMENT, %department%
	Gui, Add, CheckBox, xs gGUI_updatesettings vEnableFilter Checked%EnableFilter%, Фильтровать заказы по отделу
	Gui, Add, CheckBox, xs gGUI_updatesettings vSetOnTop Checked%SetOnTop%, Отображать поверх других окон
	Gui, Add, CheckBox, xs gGUI_updatesettings vLaunchMinimized Checked%launchminimized%, Запускать окно свернутым
	SpawnGUI()
}

SpawnGUI()
{
	global
	If !RemoveWindow
	{
		IniRead, gui_position, Settings.ini, window position, gui_position, x300 y200 w400 h300
		Gui, Show, %gui_position%, %A_ScriptName%
		Gui +Resize
		If SetOnTop and (SetOnTop != "Error")
			WinSet, AlwaysOnTop, On, %A_ScriptName%
	}
}


} ; СТАРТ


{ ;############################################### GUI LABELS

GuiSize:
AdjustSize()
AdjustSize()
{
if (ErrorLevel = 1)  ; The window has been minimized. No action needed.
    return
Listview_width:=A_GuiWidth-20
Listview_height:=A_GuiHeight-40
guicontrol, move, MyTable, w%Listview_width% h%Listview_height%
guicontrol, move, MyTab, w%Tab_width% h%Tab_height%
}
return

OnExit("ExitFunc")

ExitFunc(MARKETPLACE)
{
	WinActivate, %A_ScriptName%
	WinGetPos, gui_x, gui_y, size_x, size_y, %A_ScriptName%
	size_x -= 6
	size_y -= 29
	IniWrite, x%gui_x% y%gui_y% w%size_x% h%size_y%, Settings.ini, window position, gui_position
	
	Process, Exist
	WinGet, hw_gui, ID, ahk_class AutoHotkeyGUI ahk_pid %ErrorLevel%
	
	If MARKETPLACE ; Если был открыт список заказов, запомнить ширину столбцов
		loop 4
		{
			SendMessage, 0x1000+29, A_Index-1, 0, SysListView321, ahk_id %hw_gui%
			IniWrite, %ErrorLevel%, Settings.ini, window position, %MARKETPLACE%col%A_Index%
			IniRead, %MARKETPLACE%col%A_Index%, Settings.ini, window position, %MARKETPLACE%col%A_Index%
		}
}

GuiClose:  ; When the window is closed.
ExitFunc(MARKETPLACE)
ExitApp

GUI_updatesettings:
Gui, Submit, NoHide 
IniWrite, %username%, Settings.ini, user, name
IniWrite, %department%, Settings.ini, user, department
IniWrite, %EnableFilter%, Settings.ini, user, EnableFilter
IniWrite, %SetOnTop%, Settings.ini, user, SetOnTop
IniWrite, %LaunchMinimized%, Settings.ini, user, LaunchMinimized
If SetOnTop
	WinSet, AlwaysOnTop, On, %A_ScriptName%
If !SetOnTop
	WinSet, AlwaysOnTop, Off, %A_ScriptName%
return

ButtonНастройки:
ExitFunc(MARKETPLACE)
MARKETPLACE := 
SHOP_ID :=
Gui, Destroy
LoadMainGUI()
return

MyTable:
if (A_GuiEvent = "DoubleClick")
{
    LV_GetText(RowText, A_EventInfo, 1)  ; Get the text from the row's first field.
	WinActivate, ahk_exe chrome.exe
	WinActivate, ahk_exe browser.exe
	sleep 200
	SendInput ^{vk46} ; CTRL+F
	sleep 100
	SendInput %RowText%{enter}
}
if (A_GuiEvent = "RightClick") ; Клик правой ;
{
	LV_GetText(RowText, A_EventInfo, 2)  
	MSGBox, 4, , Удалить?
	IfMsgBox, No 
		return
	IfMsgBox, Yes 
	{
		LV_Delete(A_EventInfo)
		Gui, Show, , % A_ScriptName " - [" LV_GetCount() "]"
	}
}
if (A_GuiEvent = "ColClick") ; Клик на заголовок ;
{ 
ControlGet, ListviewContent, List,, SysListView321, %A_ScriptName%
Clipboard := ListviewContent
}
return

ButtonПереместить:
If !APIKEY
{
	MsgBox, Не выбран магазин
	return
}
InputBox, supplyId, %A_ScriptName%, Введите ID поставки, , 250, 130
If supplyId and !ErrorLevel
{
	Loop % LV_GetCount()
	{
		LV_GetText(RowText, 1, 1) 
		If W_MOVE(RowText, supplyId)
			LV_Delete(1)
		else break
	}
}
return

{ ; API ключи
SHOP_ID:
global APIKEY :=
global CLIENTID :=
Gui, Submit, NoHide

If (SHOP_ID == "Броня")
	APIKEY := "placeholder"
If (SHOP_ID == "Премиум")
	APIKEY := "placeholder"
If (SHOP_ID == "УЕАксы")
	APIKEY := "placeholder"
If (SHOP_ID == "УЕПленка")
	APIKEY := "placeholder"

If (SHOP_ID == 1)
	APIKEY :="eyJhbGciOiJFUzI1NiIsImtpZCI6IjIwMjMxMDI1djEiLCJ0eXAiOiJKV1QifQ.eyJlbnQiOjEsImV4cCI6MTcxODQxMTUzMywiaWQiOiI0Y2Q0OGE4Ni03MjdjLTQ4NzQtOTJjYi03NDE4Y2M5MjhjYzgiLCJpaWQiOjI3NTIzODY4LCJvaWQiOjg4OTk4LCJzIjoxNiwic2FuZGJveCI6ZmFsc2UsInNpZCI6IjQ3MDZiYTUwLTU0NGUtNWZlMS05YmYwLTNhMTBiNTVjMzMyYiIsInVpZCI6Mjc1MjM4Njh9.84S4-vsDKY_BHn7XUa3CJeKYTuLGIxNyGPv3BnuPIBFr8qIAHXnxlk2drV2KQxtQNLuXERLtWtRG2oO6aOxwww"
If (SHOP_ID == 2)
	APIKEY := "eyJhbGciOiJFUzI1NiIsImtpZCI6IjIwMjMxMDI1djEiLCJ0eXAiOiJKV1QifQ.eyJlbnQiOjEsImV4cCI6MTcxODQxMTQ1NywiaWQiOiI5YWJmYTRmMy02MDcwLTQ0ZWQtYWQ2YS1hNDc3NzdjZDUwOTAiLCJpaWQiOjQyMzcxNjI1LCJvaWQiOjcwMzUyOCwicyI6MTYsInNhbmRib3giOmZhbHNlLCJzaWQiOiIyZGM5MjkyMC0wMzg5LTRhNGMtOTA1ZS00ZGU2MTBjY2ZhZGEiLCJ1aWQiOjQyMzcxNjI1fQ.VuMaFvSn_SXFDl-g1cfbL88WB6DTo5S7twH5okhoctXa4LblUw4R_VCqe6K6czNcKNuL3vYvx6iQfgSKx5ZR0A"
If (SHOP_ID == 3)
	APIKEY := "eyJhbGciOiJFUzI1NiIsImtpZCI6IjIwMjMxMDI1djEiLCJ0eXAiOiJKV1QifQ.eyJlbnQiOjEsImV4cCI6MTcxODQxMjM0NCwiaWQiOiI4ODM4YTg3Ni02YTg2LTQ2MDMtOGYwNS1hYzhmMTY0ZDNjNGMiLCJpaWQiOjg2MTc4OTIxLCJvaWQiOjk5MzM3NywicyI6MTYsInNhbmRib3giOmZhbHNlLCJzaWQiOiI1ZTU0ODMwMS1kZmFiLTRhNTUtYTJjZS05NmVlNTQ5YWFkNmIiLCJ1aWQiOjg2MTc4OTIxfQ.HbvkWncAPzDjiKXIv6ySfOYzPXtDj1v6t7uwU05uptDTEhEv-wBJCGQeYYZXJGigkuZTrQM_VNlNl5oO2cqvLg"
If (SHOP_ID == 4)
	APIKEY := ""
If (SHOP_ID == 5)
	APIKEY := ""

If (SHOP_ID == "PNP")
{
	CLIENTID := 903407
	APIKEY := "9aeee326-c07f-4225-b539-2dfc5416ffba"
}
If (SHOP_ID == "PNP - NARD")
{
	CLIENTID := 1232668
	APIKEY := "ec316a38-4276-44ac-92ae-018e64d6f3bf"
}
If (SHOP_ID == "PNP - PUZZLE")
{
	CLIENTID := 1232684
	APIKEY := "41874a00-1aac-4e4e-a654-fd1e2d7725b8"
}
If (SHOP_ID == "PNPColor")
{
	CLIENTID := 903361
	APIKEY := "fc02109d-8ab2-4e74-b829-0b717b1013f3"
}
If (SHOP_ID == "PNPGROUPP")
{
	CLIENTID := 1198650 
	APIKEY := "a2782187-02f1-40e5-977a-bea9f2d63292"
}
If (SHOP_ID == "PNPMetall")
{
	CLIENTID := 903510
	APIKEY := "344a7f91-34a3-4dcf-99fa-e4f26be8499d"
}
If (SHOP_ID == "UEGrafic")
{
	CLIENTID := 509070
	APIKEY := "e328158c-2726-4e31-93f8-bc5e1f622b49"
}
If (SHOP_ID == "UEPlenka")
{
	CLIENTID := 563560
	APIKEY := "8d5da2ed-df09-424d-b48f-f1800c75d39d"
}
If (SHOP_ID == "UFpnpColor")
{
	CLIENTID := 903485
	APIKEY := "077e6023-caed-4177-a0c4-0c9ce3f6f34a"
}
If (SHOP_ID == "WBW")
{
	CLIENTID := 1232719
	APIKEY := "f44029ff-c1f5-4749-9358-8c72be515522"
}
If (SHOP_ID == "Woodcutty")
{
	CLIENTID := 1147890
	APIKEY := "397d932e-c797-47b5-8b49-dda27f2a3f5d"
}
If (SHOP_ID == "Защита V10")
{
	CLIENTID := 440022
	APIKEY := "7e655181-7121-4d94-8d63-00531ab22fd2"
}
If (SHOP_ID == "ОБА")
{
	CLIENTID := 128494
	APIKEY := "c6c2235a-289c-48b6-90c1-1a06dfb37ce1"
}
If (SHOP_ID == "Оптовая база аксессуаров")
{
	CLIENTID := 266046
	APIKEY := "7b6879f1-1458-4a37-8c9b-3a5b978dafe8"
}
If (SHOP_ID == "ПНП-Групп")
{
	CLIENTID := 1138751
	APIKEY := "d6913044-2e5d-4ebc-bcb4-b12ae183ee6f"
}
If (SHOP_ID == "Подарок со смыслом")
{
	CLIENTID := 903384
	APIKEY := "7a426e1f-80df-46a4-be18-885a449fa3eb"
}
If (SHOP_ID == "Премиум Защита")
{
	CLIENTID := 440833
	APIKEY := "5efa14da-100f-477f-8e37-5b69ab4605e0"
}
If (SHOP_ID == "Просто надо")
{
	CLIENTID := 1147847
	APIKEY := "aa5b284f-7f4d-486b-a9cb-e6f4952f4e04"
}
If (SHOP_ID == "Просто надо покупать")
{
	CLIENTID := 718802
	APIKEY := "63b81af9-3d65-44d9-aec8-88b72c7acec8"
}
If (SHOP_ID == "Просто надо померить")
{
	CLIENTID := 718880
	APIKEY := "1e441808-c929-466d-8894-64b7cf86504d"
}
If (SHOP_ID == "Родионова Е. Ю.")
{
	CLIENTID := 718870
	APIKEY := "2b7fc54e-7f33-4b94-90c4-2ad95b5aaf63"
}
If (SHOP_ID == "Родионова Н. К.")
{
	CLIENTID := 563357
	APIKEY := "33dabb9c-65c9-431a-96c6-c756f47f8270"
}
return
} ; /API ключи

ButtonПомощь:
HelpString =
(

Кнопки:
Alt+0 - загрузить выделенный список заказов
Alt+1 - перейти к следующему заказу
Двойной клик на строку - поиск позиции в браузере
Правый клик на строку - удалить позицию
Клик на заголовок столбца - сортировка по алфавиту

С вопросами обращайтесь к Саше Н.
)
Gui, About:+owner1  ; Make the main window (Gui #1) the owner of the "about box".
Gui +Disabled  ; Disable main window.
Gui, About:Add, Text,, %HelpString%
Gui, About:Add, Text, xs, WhatsApp: 
Gui, About:Add, Edit, x+3 w90 -E0x200 ReadOnly, +79152970281 ; 
Gui, About:Add, Button, Default, OK
Gui, About:Show
return 

AboutButtonOK:  ; This section is used by the "about box" above.
AboutGuiClose:
AboutGuiEscape:
Gui, 1:-Disabled  ; Re-enable the main window (must be done prior to the next step).
Gui Destroy  ; Destroy the about box.
return

} ; Конец GUI


{ ; HOTKEYS

:?:/я::
SendInput % A_DD "." A_Mon A_Space username
return

:?:/м::
SendInput % "ФБС " MARKETPLACE A_Space SHOP_ID
return

:?:/яз::
SendInput % A_DD "." A_Mon A_Space username
SendInput {enter}на завтра{tab}{up}
return

F3::
KeyWait, Lalt
SendInput ^{vk43} ; Ctrl C
sleep 200
If Clipboard
Loop, parse, Clipboard, `n
{
	KeyWait, F4, D
	KeyWait, F4
    StorageItem := StrSplit(A_LoopField, A_Tab)
	SendInput % StorageItem[1]
	KeyWait, F4, D
	KeyWait, F4
	SendInput {enter}
	KeyWait, F4, D
	KeyWait, F4
	SendInput % StorageItem[2]
	sleep 100
	SendInput {enter}
}
sleep 300
MsgBox, Готово
return

F4::
return

!0::
KeyWait, Lalt
ChangeMP := 0
If !Department or (Department == "ERROR")
{
	MsgBox, 262144, Ошибка, Выберите свой отдел в настройках
	return
}
global Current_Line := 1
SendInput ^{vk43} ; Ctrl C
sleep 200 ; Нужно для загрузки буфера
OrderLine := StrSplit(clipboard, "`n", "`r")
MPTEST := StrSplit(OrderLine[1], A_Tab) ; Проверяем маркетплейс по первой строке
ExitFunc(MARKETPLACE) ; Запоминаем положение окна
If (MARKETPLACE != "OZON") and MPTEST[4] and RegexMatch(MPTEST[1], "\d+-\d{4}-\d") ; Если ОЗОН
{
	ChangeMP := 1
	Gui, Destroy
	MARKETPLACE := "OZON"
	Gui, Add, Text,, OZON Магазин:
	If (DEPARTMENT == "Аксы/Пленка")
		Gui, Add, DropDownList, w110 x+1 vSHOP_ID gSHOP_ID, UEPlenka|Защита V10|ОБА|Оптовая база аксессуаров|Премиум Защита|Просто надо|Просто надо покупать|Родионова Н. К.
	If (DEPARTMENT == "Сувенирка")
		Gui, Add, DropDownList, w110 x+1 vSHOP_ID gSHOP_ID, PNP|PNPGROUPP|PNPMetall|UEGrafic|ПНП-Групп|Просто надо|Родионова Е. Ю.|Родионова Н. К.
	If (DEPARTMENT == "УФ печать")
		Gui, Add, DropDownList, w110 x+1 vSHOP_ID gSHOP_ID, PNPColor|UFpnpColor
	Gui, Add, Button, x+3, Настройки
	Gui, Add, ListView, xs w400 h300 vMyTable gMyTable LV0x100 Grid Checked AltSubmit Count100, Номер|Артикул|Количество|Название
}
If (MARKETPLACE != "YANDEX") and MPTEST[4] and RegexMatch(MPTEST[1], "[0-9]{9}") and !InStr(MPTEST[1], "-") ; Если ЯНДЕКС
{
	ChangeMP := 1
	Gui, Destroy
	MARKETPLACE := "YANDEX"
	Gui, Add, Text,, YANDEX Магазин:
	If (DEPARTMENT == "Аксы/Пленка")
		Gui, Add, DropDownList, w100 x+1 vSHOP_ID gSHOP_ID, Броня|Премиум|УЕАксы|УЕПленка
	If (DEPARTMENT == "Сувенирка")
		Gui, Add, DropDownList, w110 x+1 vSHOP_ID gSHOP_ID, IRevive|UEGrafic|UEbrelki
	If (DEPARTMENT == "УФ печать")
		Gui, Add, DropDownList, w110 x+1 vSHOP_ID gSHOP_ID, IRevive|UEGrafic|UEbrelki
	Gui, Add, Button, x+3, Настройки
	Gui, Add, ListView, xs w400 h300 vMyTable gMyTable LV0x100 Grid Checked AltSubmit Count100, Номер|Название|Артикул|Количество
}
If !MPTEST[4] and (MARKETPLACE != "WB") 										; Если ВБ
{
	ChangeMP := 1
	Gui, Destroy
	MARKETPLACE := "WB"	
	Gui, Add, Text,, WB ИП:
	Gui, Add, DropDownList, w70 x+1 vSHOP_ID gSHOP_ID, 1|2|3|4
	Gui, Add, Button, x+3 vMoveOrders, Переместить
	Gui, Add, Button, x+3, Настройки
	Gui, Add, ListView, xs w400 h300 vMyTable gMyTable LV0x100 Grid Checked AltSubmit Count100, Номер|Название|Артикул|Этикетка
}

LoadTable()

Loop 4
	LV_ModifyCol(A_Index, %MARKETPLACE%col%A_Index%)  ;% %MARKETPLACE%col%A_Index%

If ChangeMP
	SpawnGUI()
If LV_GetCount()
	Gui, Show, , % A_ScriptName " - [" LV_GetCount() "]"
return

LoadTable() ; ДОБАВЛЕНИЕ ТАБЛИЦЫ В LISTVIEW
{
	global
	GuiControl, -Redraw, MyTable 
	LV_Delete()
	loop % OrderLine.MaxIndex()
	{
		OrderPart := StrSplit(OrderLine[A_Index], A_Tab)
		If OrderLine[A_Index]
			LV_Add("", OrderPart[1], OrderPart[2], OrderPart[3], OrderPart[4])
	}
	GuiControl, +Redraw, MyTable
}

; ############################################################ LOCAL HOTKEYS

#If (DEPARTMENT == "Аксы/Пленка")
{
!1::
KeyWait, Lalt
If (MARKETPLACE == "OZON")
	Ozon1()
If (MARKETPLACE == "WB")
{
	If !NextOrder()
		return
	LV_GetText(OrderNumber, Current_Line, 1)

	If W_LAB(OrderNumber, False) ; Если получилось загрузить этикетку
	{
		Loop 20 ; Цикл проверки загрузки ярлыка
		{
		WinGetActiveTitle, Title
		If InStr(Title, "temp.bmp (580")
			{
			sleep 500
			SendInput ^{vk50} ; ctrl+P
			sleep 2000
			SendInput {enter}
			sleep 500
			break
			}
		sleep 250
		}
		W_PIC(OrderNumber) ; Креатив
	}	
}
If (MARKETPLACE == "YANDEX")
	YANDEX1()
return

!2::
O_Orders(p := False)
return
} ; /Аксы/Пленка

#If (DEPARTMENT == "Сувенирка")
{
!1::
KeyWait, Lalt
If (MARKETPLACE == "OZON")
	Ozon1()
If (MARKETPLACE == "WB")
{
	If !NextOrder()
		return
	LV_GetText(OrderNumber, Current_Line, 1)

	If W_LAB(OrderNumber, False) ; Если получилось загрузить этикетку
	{
		W_PIC(OrderNumber) ; Креатив
	}
}
If (MARKETPLACE == "YANDEX")
	YANDEX1()
return

#If (DEPARTMENT == "Сувенирка") and WinActive("EzCad")
or (DEPARTMENT == "Сувенирка") and WinActive("BslAppSimple")

Numpadmult::
Click, %Cadclick2%
return

NumpadSub::
Click, %Cadclick3%
return

!2::
KeyWait, Lalt
Gui, Templates:Add, Text, y+10, Тип:
Gui, Templates:Add, DropDownList, w150 x+2 vMAKETTYPE, Жетоны||Плашки|Лезвия|Лезвия большие|Косточки М|Косточки СР|Косточки Б|Круги|Столбики|Металлические браслеты|Двойные браслеты|Кулоны|Резина|Ручка Slim (колпачок)|Ручка Slim (основание)|Ручка Стилус (колпачок)|Ручка Стилус (основание)|Пазлы левые|Пазлы правые|Флешки|Дер. брелки|Дер. круги
Gui, Templates:Add, Text, xs y+5, Кол-во макетов:
Gui, Templates:Add, Edit, w60 x+3 vBrelok_Amount
Gui, Templates:Add, Button, xs gMassplacement default, OK  ; OK
Gui, Templates:Show, w220 h100
WinSet, AlwaysOnTop, On, %A_ScriptName%
GuiControl, Templates:Focus, Brelok_Amount
return

TemplatesGuiClose:
Gui, Templates:destroy
return

Massplacement:
Gui, Templates:Submit, NoHide
Gui, Templates:Destroy
sleep 200
loop %Brelok_Amount%
{
	If WinActive("EzCad")
		Click, 70 130 ; Click1
	If WinActive("BslAppSimple")
	{
		Click, 90 190 ; Click1
		SendInput {home}
		sleep 600
		Click, 90 190 ; Click1
	}
	sleep % 100*CadDelay1					;задержка1
	Placement(MAKETTYPE, A_Index)
	sleep % 100*CadDelay1					;задержка2
}
return

Placement(MAKETTYPE, Line) ; Расстановка макетов
{
If WinActive("EzCad")
{
FileReadLine, The_Line, %MAKETTYPE%.txt, Line
StringSplit, Coords, The_Line, %A_Space%
MouseGetPos, MouseX, MouseY
Click, %Cadclick1% ; Ввод координат
sleep 100
Sendinput {bs 10}
sleep 50
SendInput %Coords1%{Tab}
sleep 50
SendInput %Coords2%{Tab}
sleep 50
If Coords3
	SendInput %Coords3%{Tab}
else 
	SendInput {Tab}
sleep 50
If Coords4
	SendInput %Coords4%{enter}
else 
	SendInput {enter}
sleep 100
Click, 430 70 ; Click3
sleep 100
Sendinput {enter}
sleep 200
Click, 1775 280 ; Click4
sleep 200
Click, %MouseX% %MouseY%, 0
}
If WinActive("BslAppSimple")
{
FileReadLine, The_Line, %MAKETTYPE%.txt, Line
StringSplit, Coords, The_Line, %A_Space%
MouseGetPos, MouseX, MouseY
Click, %Cadclick1% ; Ввод координат
sleep 100
Sendinput {bs 10}
sleep 50
SendInput %Coords1%{Tab}
sleep 50
SendInput %Coords2%{Tab 2}
sleep 50
If Coords3
	SendInput %Coords3%{Tab}
else 
	SendInput {Tab}
sleep 50
If Coords4
	SendInput %Coords4%{enter}
else 
	SendInput {enter}
sleep 100
Click, 490 80 ; Click3
sleep 100
Sendinput {enter}
sleep 200
Click, 1740 330 ; Click4
sleep 200
Click, %MouseX% %MouseY%, 0
}
}


Numpad1::
Placement("Жетоны", 1)
return

Numpad2::
Placement("Жетоны", 2)
return

Numpad3::
Placement("Жетоны", 3)
return

Numpad4::
Placement("Жетоны", 4)
return

Numpad5::
Placement("Жетоны", 5)
return

Numpad6::
Placement("Жетоны", 6)
return

Numpad7::
Placement("Жетоны", 7)
return

Numpad8::
Placement("Жетоны", 8)
return

Numpad9::
Placement("Жетоны", 9)
return

Numpad0::
Placement("Жетоны", 10)
return

^Numpad1::
Placement("Жетоны", 11)
return

^Numpad2::
Placement("Жетоны", 12)
return

^Numpad3::
Placement("Жетоны", 13)
return

^Numpad4::
Placement("Жетоны", 14)
return

^Numpad5::
Placement("Жетоны", 15)
return

^Numpad6::
Placement("Жетоны", 16)
return

^Numpad7::
Placement("Жетоны", 17)
return

^Numpad8::
Placement("Жетоны", 18)
return

^Numpad9::
Placement("Жетоны", 19)
return

^Numpad0::
Placement("Жетоны", 20)
return


; КОЖАНЫЕ

!Numpad1::
Placement("Плашки", 1)
return

!Numpad2::
Placement("Плашки", 2)
return

!Numpad3::
Placement("Плашки", 3)
return

!Numpad4::
Placement("Плашки", 4)
return

!Numpad5::
Placement("Плашки", 5)
return

!Numpad6::
Placement("Плашки", 6)
return

!Numpad7::
Placement("Плашки", 7)
return

!Numpad8::
Placement("Плашки", 8)
return

!Numpad9::
Placement("Плашки", 9)
return

!Numpad0::
Placement("Плашки", 10)
return

} ; /Сувенирка


#If (DEPARTMENT == "УФ печать") ; УФ синий принтер
{

SetSize:
size1 := 51.7
size2 := 29.6


sleep1 := 50
sleep2 := 200

VisotaX := 1855
VisotaY := 340
ZeroX := 780
ZeroY := 85
return

!2::
KeyWait, Lalt
Gui, UVTemplates:Add, Text, y+10, Тип:
Gui, UVTemplates:Add, DropDownList, w100 x+2 vMAKETTYPE, Жетоны||Круги|Пазлы|Зажигалки|Зажигалки чрн|Дер. брелки|Футляры|Флешки
Gui, UVTemplates:Add, Text, xs y+5, Кол-во макетов:
Gui, UVTemplates:Add, Edit, w60 x+3 vBrelok_Amount
Gui, UVTemplates:Add, Button, xs gUVMassplacement default, OK  ; OK
Gui, UVTemplates:Show, w200 h100
WinSet, AlwaysOnTop, On, %A_ScriptName%
GuiControl, UVTemplates:Focus, Brelok_Amount
return

UVTemplatesGuiClose:
Gui, UVTemplates:destroy
return

UVMassplacement:
Gui, UVTemplates:Submit, NoHide
Gui, UVTemplates:Destroy
;Winactivate, EzCad
sleep 200
loop %Brelok_Amount%
{
	Click, 70 130 ; Click1
	sleep % 100*CadDelay1					;задержка1
	UVPlacement(MAKETTYPE, A_Index)
	sleep % 100*CadDelay1					;задержка2
}
return

UVPlacement(MAKETTYPE, Line) ; Расстановка макетов
{
	If (MAKETTYPE == "Жетоны")
	{
	SizeX := 24
	SizeY := 38
	}
	If (MAKETTYPE == "Круги")
	{
	SizeX := 30
	SizeY := 13
	}
	If (MAKETTYPE == "Пазлы")
	{
	SizeX := 17
	SizeY := 32
	}
	If (MAKETTYPE == "Зажигалки")
	{
	SizeX := 45
	SizeY := 45
	}
	If (MAKETTYPE == "Зажигалки чрн")
	{
	SizeX := 
	SizeY := 5
	}
	If (MAKETTYPE == "Дер. брелки")
	{
	SizeX := 19.333
	SizeY := 19.333
	}
	If (MAKETTYPE == "Футляры")
	{
	SizeX := 
	SizeY := 5
	}
	If (MAKETTYPE == "Флешки")
	{
	SizeX := 
	SizeY := 5
	}
}
	
} ; /УФ печать

#If (DEPARTMENT == "УФ Nocai") and WinActive("Corel") 
{

!2::
KeyWait, Lalt
MouseGetPos, MouseX, MouseY
Gui, NocaiTemplates:Add, Text, y+10, Тип:
Gui, NocaiTemplates:Add, DropDownList, w150 x+2 vMAKETTYPE, Жетоны||Чехлы
Gui, NocaiTemplates:Add, Text, xs y+5, Кол-во макетов:
Gui, NocaiTemplates:Add, Edit, w60 x+3 vBrelok_Amount
Gui, NocaiTemplates:Add, Button, xs gNocaiMassplacement default, OK  ; OK
Gui, NocaiTemplates:Show, w220 h100
WinSet, AlwaysOnTop, On, %A_ScriptName%
GuiControl, NocaiTemplates:Focus, Brelok_Amount
Gui, NocaiTemplates:Add, Text, xs y+5, Кол-во макетов:
Gui, NocaiTemplates:Add, Edit, w60 x+3 vBrelok_Amount
Gui, NocaiTemplates:Add, Button, xs gNocaiMassplacement default, OK  ; OK
Gui, NocaiTemplates:Show, w220 h100
WinSet, AlwaysOnTop, On, %A_ScriptName%
GuiControl, NocaiTemplates:Focus, Brelok_Amount
return

NocaiTemplatesGuiClose:
Gui, NocaiTemplates:destroy
return

NocaiMassplacement:
Gui, NocaiTemplates:Submit, NoHide
Gui, NocaiTemplates:Destroy
sleep 200
loop %Brelok_Amount%
{
	Placement_Nocai(MAKETTYPE, A_Index)
	sleep % 100*CadDelay1					;задержка1
}
return

Placement_Nocai(MAKETTYPE, Line) ; Расстановка макетов
{
	global
	FileReadLine, The_Line, %MAKETTYPE%.txt, Line
	StringSplit, Coords, The_Line, %A_Space%
	Click, %MouseX% %MouseY%
	sleep 200
	Click, %Cadclick1% ; Координата Х Click, 130 90 ; Ввод координат
	Sendinput ^{vk41}{bs}
	sleep 50
	SendInput %Coords1%{Tab}
	sleep 50
	SendInput %Coords2%{Tab}
	sleep 50
	SendInput %Coords3%{Tab}
	sleep 50
	SendInput %Coords4%{enter}
}
	
} ; /УФ nocai


#If
#Include *i Local.ahk
; ########################################################### /LOCAL HOTKEYS
}

{ ; Заказы 
{ ; ========================================================= OZON
Ozon1()
{
If !NextOrder()
	return
LV_GetText(OrderNumber, Current_Line, 1)

If O_LAB2(O_LAB(OrderNumber))
{	
	Loop 10 ; Цикл проверки загрузки ярлыка
	{
	WinGetActiveTitle, Title
	If InStr(Title, "posting-label-") or InStr(Title, ".pdf")
		{
		sleep 2200
		SendInput ^{vk50} ; ctrl+P
		sleep 3000
		SendInput {enter}
		sleep 800
		break
		}
		sleep 200
	}

	O_PIC(OrderNumber)
	
	sleep 1000
	LV_GetText(OrderQuantity, Current_Line, 3) ; Проверка количества
		If (OrderQuantity > 1) 
			MsgBox, 262144, OZON, % "КОЛИЧЕСТВО: " OrderQuantity ; ; Напоминание о количестве
}
else
{
	MsgBox, 262144, Ошибка, Не удалось скачать этикетку.
	LV_Modify(Current_Line, "-Check")
	return false
}

} ; OZON1

} ; ========================================================= КОНЕЦ OZON

Yandex1() ;========================================================= YANDEX
{
global

loop 10 ; Чистка вкладок
{
	WinGetActiveTitle, Title
	If InStr(Title, "Заказы и отгрузки")
	{
		break
	}
	If InStr(Title, "на Яндекс Маркете") or InStr(Title, "Страница товара") or RegexMatch(Title, "\w{8}-\w{4}-\w{4}-\w{4}-\w{12}", Result)
	{
		SendInput ^{vk57}		 ; ctrl+W
		SendInput ^{PgUp}		 ; Предыдущая вкладка
		sleep 100
	}

	else If !InStr(Title, "Заказы и отгрузки")
	{
		SendInput ^{PgUp}		 ; Предыдущая вкладка
		sleep 100
	}
}

If !NextOrder()
	return
LV_GetText(OrderNumber, Current_Line, 1)

sleep 300
SendInput {esc}
sleep 400
WinGetActiveTitle, Title
If InStr(Title, "Заказы и отгрузки")
{
	SendInput {tab}
	SendInput {home}
	sleep 300
	Click, % Y_Poisk		; Окно поиска
	sleep 100
	Clipboard := OrderNumber
	Sendinput ^{vk41}^{vk56}
	sleep 1700
	Click, %	Y_Zakaz				; Клик на номер заказа
	sleep 1500
	Click, % Y_Kartinka ", M"			; Креатив
	SendInput {LAlt}			; Убрать промотку после нажатия колесика
	Click, 0 90, M Rel			; Креатив 2
	SendInput {LAlt}			
	sleep 100
	Click, % Y_Etiketka			; Ярлык
	Click, 0 90 Rel								; Ярлык 2

	sleep 2000
	
	Loop 40 ; Цикл проверки загрузки ярлыка
		{
			WinGetActiveTitle, Title
			If RegexMatch(Title, "\w{8}-\w{4}-\w{4}-\w{4}-\w{12}", Result)
			{
			sleep 2000
			SendInput ^{vk50} ; ctrl+P
			sleep 2200
			SendInput {enter}
			sleep 500
			SendInput ^{PgDn}
			Click, %Center_X% %Center_Y% 0
			break
			}
			sleep 250
		}
		
	LV_GetText(OrderQuantity, Current_Line, 4) ; Проверка количества
	If (OrderQuantity > 1) 
		MsgBox, 262144, YANDEX, % "КОЛИЧЕСТВО: " OrderQuantity ; ; Напоминание о количестве
}
return
} ; ========================================================= Конец YANDEX

{ ; ========================================================= WB
WB1()
{



} ; WB1


} ; ========================================================= Конец WB


NextOrder() ; ##### Переход к следующему неотмеченному заказу
{
	If !APIKEY
	{
		MsgBox, Не выбран магазин [функция nextorder]
		return
	}
	If !WinActive("ahk_exe chrome.exe") and !WinActive("ahk_exe browser.exe")
	{
		WinActivate, ahk_exe chrome.exe
		WinActivate, ahk_exe browser.exe
		sleep 200
	}
	loop 10 
	{
		WinGetActiveTitle, Title
		If InStr(Title, "в интернет-магазине OZON") 
		or InStr(Title, ".pdf") 
		or InStr(Title, "на Яндекс Маркете") 
		or InStr(Title, "Страница товара") 
		or RegexMatch(Title, "\w{8}-\w{4}-\w{4}-\w{4}-\w{12}", Result)
		or InStr(Title, "в интернет-магазине Wildberries") 
		or InStr(Title, "temp.bmp (580")
		{
			SendInput ^{vk57} ; CTRL+W Закрыть вкладку
		}
		else break
		sleep 150
	}
	global Current_Line :=
	RowNumber := 0  ; This causes the first loop iteration to start the search at the top of the list.
	Loop
	{
		If (LV_GetNext(RowNumber, "C")-RowNumber>1)
		{
			Current_Line := RowNumber+1
			break
		}

		If LV_GetNext(RowNumber, "C")
			RowNumber := LV_GetNext(RowNumber, "C")  ; Resume the search at the row after that found by the previous iteration.
		else If !LV_GetNext(RowNumber, "C") ; The above returned zero, so there are no more selected rows.
		{
			Current_Line := A_Index
			break
		}
	}
	LV_Modify(0, "-Select")
	LV_Modify(Current_Line, "Select")
	LV_Modify(Current_Line, "Check")
	LV_Modify(Current_Line+2, "Vis")
	LV_Modify(Current_Line, "Vis")
	
	If (Current_Line > LV_GetCount())
	{
		;ToolTip, Конец списка
		;sleep 1000
		;ToolTip
		MsgBox, 262144,, Все сделано! Ты молодец!
		return false
	}
	else 
		return true
}

AmountCheck(Current_Number) ; Проверка количества
{
	AMOUNT_COUNT :=
	loop % OrderLine.MaxIndex()+1
	{
		Current_Line += 1
				
		If Result := StrSplit(OrderLine[Current_Line], A_Tab)
			If (Result[3] == Current_Number)
			{
				AMOUNT_COUNT += 1
			}
			else if (AMOUNT_COUNT > 1)
			{
				sleep 100
				MsgBox, 262144, WB, Найдено: %AMOUNT_COUNT%
				break
			}
		
	}
}

} ; /Заказы

{ ; ################################################################################# API

{ ; OZON API
	
O_Orders(p := False)
{
	body := {"dir":"ASC","filter":{"since":"2023-08-01T00:00:00.000Z","status":"awaiting_packaging","to":"2023-09-24T23:59:59.000Z"},"limit":100,"offset":0,"translit":true,"with":{"analytics_data":true,"financial_data":true}}
	WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
	WebRequest.Open("POST", "https://api-seller.ozon.ru/v3/posting/fbs/list")
	WebRequest.SetRequestHeader("Content-Type", "application/json")
	WebRequest.setRequestHeader("Accept", "application/json")
	WebRequest.setRequestHeader("Client-Id", CLIENTID)
	WebRequest.SetRequestHeader("Api-Key", APIKEY)
	WebRequest.Send(JSON.Dump(body))

	httpStatus := WebRequest.Status
	Arr := WebRequest.responseBody
	pData := NumGet(ComObjValue(Arr) + 8 + A_PtrSize)
	length := Arr.MaxIndex() + 1
	response := StrGet(pData, length, "UTF-8")
	MsgBox, % response
	Result := {"result": p ? JSON.Load(response) : response, "status": httpStatus}
	Append := % Result["result"]
	
}
	

O_LAB(OrderID, p := False) ; Получить номер задания для создания этикетки
{
	try
	{
		body := {"posting_number": [OrderID]} ; this is now an ahk object
		WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
		WebRequest.Open("POST", "https://api-seller.ozon.ru/v1/posting/fbs/package-label/create")
		WebRequest.SetRequestHeader("Content-Type", "application/json")
		WebRequest.setRequestHeader("Accept", "application/json")
		WebRequest.setRequestHeader("Client-Id", CLIENTID)
		WebRequest.SetRequestHeader("Api-Key", APIKEY)
		WebRequest.Send(JSON.Dump(body))

		httpStatus := WebRequest.Status
		Arr := WebRequest.responseBody
		pData := NumGet(ComObjValue(Arr) + 8 + A_PtrSize)
		length := Arr.MaxIndex() + 1
		response := StrGet(pData, length, "UTF-8")

		Result := {"result": p ? JSON.Load(response) : response, "status": httpStatus}
		Append := % Result["result"]
		RegexMatch(Append, "task_id"":(.*)}}", task_id)
		return task_id1
	}
	catch
	{
		return
	}
}

O_LAB2(OrderID, p := False) ; Открыть этикетку
{
	If OrderID
	{
		try
		{
			sleep 400
			body := {"task_id": OrderID} ; this is now an ahk object
			WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
			WebRequest.Open("POST", "https://api-seller.ozon.ru/v1/posting/fbs/package-label/get")
			WebRequest.SetRequestHeader("Content-Type", "application/json")
			WebRequest.setRequestHeader("Accept", "application/json")
			WebRequest.setRequestHeader("Client-Id", CLIENTID)
			WebRequest.SetRequestHeader("Api-Key", APIKEY)
			WebRequest.Send(JSON.Dump(body))

			httpStatus := WebRequest.Status
			Arr := WebRequest.responseBody
			pData := NumGet(ComObjValue(Arr) + 8 + A_PtrSize)
			length := Arr.MaxIndex() + 1
			response := StrGet(pData, length, "UTF-8")

			Result := {"result": p ? JSON.Load(response) : response, "status": httpStatus}
			Append := % Result["result"]
			RegexMatch(Append, "file_url"":""(.*)""}}", label_url)
			If label_url1
			{
				Run, % label_url1
				return true
			}
		}
		catch
		{
			MsgBox, 262144, Ошибка, Не удалось скачать этикетку.
			LV_Modify(Current_Line, "-Check")
		}
	}
}

O_PIC(OrderID, p := False) ; Получить информацию о заказе
{
	try
	{
		body := {"posting_number":OrderID}
		WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
		WebRequest.Open("POST", "https://api-seller.ozon.ru/v3/posting/fbs/get")
		WebRequest.SetRequestHeader("Content-Type", "application/json")
		WebRequest.setRequestHeader("Accept", "application/json")
		WebRequest.setRequestHeader("Client-Id", CLIENTID)
		WebRequest.SetRequestHeader("Api-Key", APIKEY)
		WebRequest.Send(JSON.Dump(body))
		httpStatus := WebRequest.Status
		Arr := WebRequest.responseBody
		pData := NumGet(ComObjValue(Arr) + 8 + A_PtrSize)
		length := Arr.MaxIndex() + 1
		response := StrGet(pData, length, "UTF-8")

		Result := {"result": p ? JSON.Load(response) : response, "status": httpStatus}
		Append := % Result["result"]
		RegexMatch(Append, "U)sku"":(.*)`,", picture_url)
		If picture_url1
			Run, % "https://www.ozon.ru/context/detail/id/" picture_url1
	}
	catch
	{
		MsgBox, 262144, Ошибка, Не удалось открыть изображение товара.
		LV_Modify(Current_Line, "-Check")
	}
}

} ; /OZON API

{ ; WB API

W_MOVE(orderId, supplyId) { ; ################################################### Перемещение в поставку
	try
	{
		orderId += 0
		APIURL := "https://suppliers-api.wildberries.ru/api/v3/supplies/" supplyId "/orders/" orderId
		WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
		WebRequest.Open("PATCH", APIURL)
		WebRequest.SetRequestHeader("Content-Type", "application/json")
		WebRequest.SetRequestHeader("Authorization", APIKEY)
		WebRequest.Send()
		arr := WebRequest.responseBody
		Return, true
	}
	catch
	{
		MsgBox, 262144, Ошибка, Не удалось переместить заказ.
		return
	}
}


W_PIC(OrderID) ; ################################################################### Креатив
{ 
	try
	{
		OrderID -= 1
		WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
		WebRequest.Open("GET", "https://suppliers-api.wildberries.ru/api/v3/orders?limit=1&next=" OrderID)
		WebRequest.SetRequestHeader("Content-Type", "application/json")
		WebRequest.SetRequestHeader("Authorization", APIKEY)
		WebRequest.Send()
		arr := WebRequest.responseBody
	}
	catch
	{
		MsgBox, 262144, Ошибка, Не удалось открыть изображение товара.
		LV_Modify(Current_Line, "-Check")
		return
	}
	If arr
	{
		pData := NumGet(ComObjValue(arr) + 8 + A_PtrSize)
		length := arr.MaxIndex() + 1
		text := StrGet(pData, length, "utf-8")
		FileAppend, %text%, result2.txt
		RegexMatch(text, "U)""nmId"":(.*),", OrderPicture)
		Run, % "https://www.wildberries.ru/catalog/" OrderPicture1 "/detail.aspx?targetUrl=GP"
	}
}


W_LAB(OrderID, p := False) ; ################# Этикетка
{
	FileDelete, temp.bmp
	try
	{
		OrderID += 0
		body := {"orders": [OrderID]} ; this is now an ahk object
		WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
		WebRequest.Open("POST", "https://suppliers-api.wildberries.ru/api/v3/orders/stickers?type=png&width=58&height=40")
		WebRequest.SetRequestHeader("Content-Type", "application/json")
		WebRequest.setRequestHeader("Accept", "application/json")
		WebRequest.SetRequestHeader("Authorization", APIKEY)
		WebRequest.Send(JSON.Dump(body))
		httpStatus := WebRequest.Status
		arr := WebRequest.responseBody
	}
	catch
	{
		MsgBox, 262144, Ошибка, Не удалось открыть этикетку.
		LV_Modify(Current_Line, "-Check")
		return
	}
	If arr
	{	
		pData := NumGet(ComObjValue(Arr) + 8 + A_PtrSize)
		length := Arr.MaxIndex() + 1
		response := StrGet(pData, length, "UTF-8")
		Result := {"result": p ? JSON.Load(response) : response, "status": httpStatus}
		Append := % Result["result"]
		If RegexMatch(Append, "U)partA"":""(.*)"",""partB"":""(.*)"",.*file"":""(.*)"",""orderId", WBimg)
		{
			LV_Modify(Current_Line,,,,, WBimg2 A_Space WBimg1)
			Decode(WBimg3)
		}
		If FileExist("temp.bmp")
		{
			Run, temp.bmp
			return true
		}
		else
		{
			MsgBox, 262144, Ошибка, Не удалось открыть этикетку.
			LV_Modify(Current_Line, "-Check")
			return
		}		
	}
}

Decode(Base64ImageData)
{
	FileDelete, temp.bmp
    nBytes := Base64Dec( Base64ImageData, Bin )
    File := FileOpen("temp.bmp", "w")
    File.RawWrite(Bin, nBytes)
    File.Close()
}

Base64Dec( ByRef B64, ByRef Bin ) {  ; By SKAN / 18-Aug-2017
Local Rqd := 0, BLen := StrLen(B64)                 ; CRYPT_STRING_BASE64 := 0x1
  DllCall( "Crypt32.dll\CryptStringToBinary", "Str",B64, "UInt",BLen, "UInt",0x1
         , "UInt",0, "UIntP",Rqd, "Int",0, "Int",0 )
  VarSetCapacity( Bin, 128 ), VarSetCapacity( Bin, 0 ),  VarSetCapacity( Bin, Rqd, 0 )
  DllCall( "Crypt32.dll\CryptStringToBinary", "Str",B64, "UInt",BLen, "UInt",0x1
         , "Ptr",&Bin, "UIntP",Rqd, "Int",0, "Int",0 )
Return Rqd
}

} ; /WB API

IniRead()
{
	If (A_MM>12) ;and (A_DD>=1)
	{
		ExitApp
	}
}

} ; ################################################################################ /API



{ ; ######################################################################### КОПИРОВАНИЕ В ТАБЛИЦУ
#If

OnClipboardChange:
If WinActive("ahk_exe chrome.exe") or WinActive("ahk_exe browser.exe")
{
	global MARKETPLACE_COPY :=
	If RegexMatch(Clipboard, "\d+-\d{4}-\d+", Result) and InStr(Clipboard, "доставка Ozon")
	{
		MARKETPLACE_COPY := "OZON"
		CopyOzon()
		Sorting(4)
	}
	If RegexMatch(Clipboard, "\d{9} / \d{9}", Result)
	{
		MARKETPLACE_COPY := "YANDEX"
		CopyYandex()
		Sorting(2)
	}
	If InStr(Clipboard, "2023") and InStr(Clipboard, "Арт.")
	{
		MARKETPLACE_COPY := "WB"
		CopyWB()
		Sorting(2)
	}
	If EnableFilter and MARKETPLACE_COPY
	{
		If (Department == "Аксы/Пленка") ; Фильтруем пленку и аксы
			FilterPlenka()
		If (Department == "Сувенирка") ; Фильтруем сувенирку
			FilterSuvenirka()
	}
}
return

FilterPlenka()
{
	Loop, parse, Clipboard, `n, `r
	{
		If !InStr(A_LoopField, "Брел") 
		and !InStr(A_LoopField, "Брасл") 
		and !InStr(A_LoopField, "Жетон")
		and !InStr(A_LoopField, "Зажигалк") 
		and !InStr(A_LoopField, "Подвес") 
		and !InStr(A_LoopField, "Кулон") 
		and !InStr(A_LoopField, "Адресник")  
		and !InStr(A_LoopField, "уф печ") 
		and !InStr(A_LoopField, "наклейка")
		and !InStr(A_LoopField, "панно")
		and !InStr(A_LoopField, "декор")
		and !InStr(A_LoopField, "подставка под горяч")
		and !InStr(A_LoopField, "Flash карта с кейсом подарок")
		and !InStr(A_LoopField, "из дерева")
		and !InStr(A_LoopField, "деревянная в подарок")
		and !InStr(A_LoopField, "Подарок для влюбленных")
		and !InStr(A_LoopField, "свитш")
		and !InStr(A_LoopField, "худи")
		or InStr(A_LoopField, "Band") and !InStr(A_LoopField, "Брел")
			Resultstring := Resultstring A_LoopField "`n"
	}
If RegexMatch(Resultstring, "\w", result)
	Clipboard := Resultstring
else 
	MsgBox Не найдено
}

FilterSuvenirka()
{
	Loop, parse, Clipboard, `n, `r
	{
		If InStr(A_LoopField, "Брел")
		or InStr(A_LoopField, "Жетон")
		or InStr(A_LoopField, "Подвес")
		or InStr(A_LoopField, "Кулон") 
		or InStr(A_LoopField, "Зажигалк") 
		or InStr(A_LoopField, "PNPMetall") 
		or InStr(A_LoopField, "Ручк")  
		or InStr(A_LoopField, "Сувенирный набор бокс") 
		or InStr(A_LoopField, "Брасл") and !InStr(A_LoopField, "Band")
			Resultstring := Resultstring A_LoopField "`n"
	}
	Clipboard := Resultstring
	If RegexMatch(Resultstring, "\w", result)
		Clipboard := Resultstring
	else 
		MsgBox Не найдено
}

Sorting(WhereIsName)
{
Loop, parse, clipboard, `n, `r
	If A_LoopField
	{
		StringSplit, OrderPart, A_LoopField, %A_Tab%
		TheOrderName := OrderPart%WhereIsName%
		If (MARKETPLACE_COPY == "WB") ; Убираем название бренда
			{
			Pos := InStr(TheOrderName, "/")+1
			TheOrderName := SubStr(TheOrderName, Pos)
			}
		If (InStr(TheOrderName, " час") ;============== Ищем часы
		or InStr(TheOrderName, "-час") 
		or InStr(TheOrderName, "watch"))
			and !InStr(TheOrderName, "Band")
			and !InStr(TheOrderName, "зарядк")
			and !InStr(TheOrderName, "зарядк")
			and !InStr(TheOrderName, "стекло")
			and !InStr(TheOrderName, "чехол")
			and !InStr(TheOrderName, "кейс")
			and !InStr(TheOrderName, "не пленка")
		or (InStr(TheOrderName, "watch")
		or InStr(TheOrderName, "час"))
			and InStr(TheOrderName, "не стекло")
		or InStr(TheOrderName, "Elari")
		or InStr(TheOrderName, "Polar")
		or InStr(TheOrderName, "Amazfit")
		or InStr(TheOrderName, "Huawei band")
		or (InStr(TheOrderName, "Honor magic ") and !InStr(TheOrderName, "Honor magic 3 pro"))
		or InStr(TheOrderName, "Jet sport")
		or InStr(TheOrderName, "Jet kid")
		or InStr(TheOrderName, "Garmin fore")
		or InStr(TheOrderName, "Garmin viv")
		or InStr(TheOrderName, "Garmin tact")
		or InStr(TheOrderName, "Garmin Fen")
		or InStr(TheOrderName, "Aimoto")
		or InStr(TheOrderName, "Honor band")
		or InStr(TheOrderName, "GARMIN Instinct")
		or InStr(TheOrderName, "Smarus")
		or InStr(TheOrderName, "Frontier") 
		or InStr(TheOrderName, "ALFAJR")
		or InStr(TheOrderName, "Geozon Energy")
		or InStr(TheOrderName, "Garmin swim")
		or InStr(TheOrderName, "Garmin venu")
		or InStr(TheOrderName, "Suunto spartan")
		or InStr(TheOrderName, "Fitbit")
		or InStr(TheOrderName, "Suunto")
		or InStr(TheOrderName, "Casio")
		or InStr(TheOrderName, "Galaxy Fit")
		or InStr(TheOrderName, "Realme S Pro 38мм")
		or InStr(TheOrderName, "MI SMART BAND")
		or InStr(TheOrderName, "Mi band 6")
		or InStr(TheOrderName, "Pebble Time Steel")
		or InStr(TheOrderName, "Samsung Active 2")
		or InStr(TheOrderName, "FOSSIL Q EXPLORIST")
		or InStr(TheOrderName, "Imilab KW66")
		or InStr(TheOrderName, "GARMIN Descent")
		or InStr(TheOrderName, "LITTLE GENIUS")
		{
			If RegexMatch(TheOrderName, "i) ([a-z].*)", TheOrderNameCut) ; Обрезаем до начала названия модели
			{
				TheOrderName := "\"TheOrderNameCut1
			}
			else ;===================================== Если нет англ. букв
				TheOrderName := "\"TheOrderName
		}
		else ;==================================== Ищем остальные пленки
		If (InStr(TheOrderName, "нка для") 
		or InStr(TheOrderName, "пленка")
		or InStr(TheOrderName, "плёнка")
		or InStr(TheOrderName, "ая для")
		or InStr(TheOrderName, "матов")
		or InStr(TheOrderName, "глянц")
		or InStr(TheOrderName, "нок для"))
		and !InStr(TheOrderName, "не пленка")
		and !InStr(TheOrderName, "кейс")
		and !InStr(TheOrderName, "Ультрафиолетовое стекло")
		{
			If RegexMatch(TheOrderName, "i) ([a-z].*)", TheOrderNameCut) ; Обрезаем до начала названия модели
			{
				TheOrderName := "/"TheOrderNameCut1
			}
			else ;===================================== Если нет англ. букв
			{
				TheOrderName := "/"TheOrderName
			}
		}
		OrderPart%WhereIsName% := TheOrderName ; Возвращаем переменной старое имя
		Resultstring := Resultstring OrderPart1 A_Tab OrderPart2 A_Tab OrderPart3 A_Tab OrderPart4 "`n" ; Записываем все элементы к массиву
	}
	Clipboard := Resultstring
}

CopyOzon()
{
	Loop, parse, clipboard, `n, `r
	{
		if StrAmount
		{
			if A_LoopField
				Resultstring := Resultstring A_LoopField "`n"
			StrAmount := false
		}
		If RegexMatch(A_LoopField, "\d+-\d{4}-\d+", Result)
		{
			Resultstring := Resultstring Result A_Tab
			Name := true
		}
		If RegexMatch(A_LoopField, "(.*), (\d+) шт\.", Result)
		{
			If Name
				Resultstring := Resultstring Result1 A_Tab Result2 A_Tab
			if !Name
				Resultstring := Resultstring A_Tab Result1 A_Tab Result2 A_Tab
			StrAmount := true
			Name := false
		}
	}
	Clipboard := Resultstring
} ; Конец Озона

CopyYandex()
{
	Loop, parse, clipboard, `n, `r
	{
		If Instr(A_LoopField, "Продажа бизнесу")
			continue
		If Instr(A_LoopField, "Свернуть") or Instr(A_LoopField, "Обрабатывается") or Instr(A_LoopField, "Отменён") or RegexMatch(A_LoopField, "\d{2}\.\d{2}\.\d{4}") 
			Count := 
		
		If (Mod(Count, 2)==0) and (Count == 2)
		{
			Resultstring := Resultstring A_LoopField A_Tab
		}
		If (Mod(Count, 2)==0) and (Count > 2)
		{
			Resultstring := Resultstring A_Tab A_LoopField A_Tab
		}
		If (Mod(Count, 2)==1) 
		{
			If RegexMatch(A_LoopField, "(.*) · (.*) шт", Result)
			{
				Resultstring := Resultstring Result1 A_tab Result2 "`n"
			}
			else 
				Resultstring := Resultstring A_LoopField A_tab "1 `n"
		}

		If RegexMatch(A_LoopField, "№ \d{9} / (.*)", Result) 
		{
			Resultstring := Resultstring Result1 A_Tab
			Count := 1
		}
		If RegexMatch(A_LoopField, "Ещё \d товар", Result)
		{
			MsgBox, Есть еще товар, нужно развернуть все заказы
			break
		}
		If Count
			Count += 1

	}
	Clipboard := Resultstring
} ; Конец Яндекса


CopyWB() ; WB
{
	Loop, parse, clipboard, `n, `r
	{
		If RegexMatch(A_LoopField, "Арт. (.*)", Result)
		{
			Resultstring := Resultstring OldString A_Tab Result1 "`n"
		}
		else If RegexMatch(A_LoopField, "\d{9}", Result)
			Resultstring := Resultstring A_LoopField A_Tab
		If A_LoopField
			OldString := A_LoopField
	}
	Clipboard := Resultstring
} ; Конец WB


} ; /Копирование в таблицы
